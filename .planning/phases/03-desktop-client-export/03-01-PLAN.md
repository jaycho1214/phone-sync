---
phase: 03-desktop-client-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/desktop_client/pubspec.yaml
  - apps/desktop_client/lib/main.dart
  - apps/desktop_client/lib/app.dart
  - apps/desktop_client/lib/services/discovery_service.dart
  - apps/desktop_client/lib/services/sync_service.dart
  - apps/desktop_client/lib/services/session_storage.dart
  - apps/desktop_client/lib/providers/discovery_provider.dart
  - apps/desktop_client/lib/providers/session_provider.dart
  - apps/desktop_client/lib/screens/discovery_screen.dart
  - apps/desktop_client/lib/screens/pairing_screen.dart
  - apps/desktop_client/lib/widgets/pin_input.dart
  - apps/desktop_client/lib/widgets/device_card.dart
  - apps/desktop_client/macos/Runner/DebugProfile.entitlements
  - apps/desktop_client/macos/Runner/Release.entitlements
  - apps/desktop_client/windows/runner/main.cpp
autonomous: true

must_haves:
  truths:
    - "Desktop app discovers Android devices advertising _phonesync._tcp on local network"
    - "User can select a discovered device and enter PIN to pair"
    - "Session token is persisted and survives app restart"
    - "User can manually enter IP:port if mDNS fails"
  artifacts:
    - path: "apps/desktop_client/pubspec.yaml"
      provides: "Desktop app dependencies"
      contains: "nsd|dio|flutter_secure_storage|pinput"
    - path: "apps/desktop_client/lib/services/discovery_service.dart"
      provides: "mDNS discovery for _phonesync._tcp"
      exports: ["DiscoveryService"]
    - path: "apps/desktop_client/lib/services/sync_service.dart"
      provides: "HTTP client with self-signed cert trust"
      exports: ["SyncService"]
    - path: "apps/desktop_client/lib/screens/pairing_screen.dart"
      provides: "6-digit PIN entry with auto-advance"
      min_lines: 50
  key_links:
    - from: "apps/desktop_client/lib/screens/discovery_screen.dart"
      to: "DiscoveryService"
      via: "Riverpod provider"
      pattern: "ref\\.watch.*discoveryProvider"
    - from: "apps/desktop_client/lib/screens/pairing_screen.dart"
      to: "SyncService"
      via: "POST /pair call"
      pattern: "pair\\(.*pin"
---

<objective>
Create the desktop Flutter app with mDNS device discovery and PIN-based pairing flow.

Purpose: Establishes the desktop client foundation and secure connection to Android device - prerequisite for data sync and export.

Output: Working desktop app (Windows + Mac) that discovers Android devices, shows PIN entry, and persists session token for auto-reconnect.
</objective>

<execution_context>
@/Users/jay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-desktop-client-export/03-CONTEXT.md
@.planning/phases/03-desktop-client-export/03-RESEARCH.md
@.planning/phases/02-network-protocol/02-02-SUMMARY.md

# API contract from Android server
# POST /pair: {"pin": "123456"} -> {"status": "paired", "sessionToken": "..."}
# GET /contacts, /sms, /calls require: Authorization: Bearer {token}
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create desktop_client app with dependencies</name>
  <files>
    apps/desktop_client/pubspec.yaml
    apps/desktop_client/lib/main.dart
    apps/desktop_client/lib/app.dart
    apps/desktop_client/macos/Runner/DebugProfile.entitlements
    apps/desktop_client/macos/Runner/Release.entitlements
  </files>
  <action>
Create new Flutter app in apps/desktop_client:

```bash
cd /Users/jay/Codes/jljm/jljm-phonesync/apps
flutter create --platforms=windows,macos --org com.jljm desktop_client
```

Update pubspec.yaml with dependencies:
```yaml
dependencies:
  flutter:
    sdk: flutter
  flutter_riverpod: ^2.6.1
  nsd: ^4.1.0
  dio: ^5.8.0
  flutter_secure_storage: ^9.0.0
  pinput: ^6.0.1
  path_provider: ^2.1.5
  core:
    path: ../../packages/core

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^5.0.0
```

Create main.dart with ProviderScope:
```dart
void main() {
  runApp(const ProviderScope(child: PhoneSyncApp()));
}
```

Create app.dart with MaterialApp, modern/minimal theme (clean, subtle shadows), initial route to DiscoveryScreen.

For macOS, add network entitlements to both DebugProfile.entitlements and Release.entitlements:
```xml
<key>com.apple.security.network.client</key>
<true/>
<key>com.apple.security.network.server</key>
<true/>
```

Note: Windows network access is automatic (firewall prompt on first run).

Run `melos bootstrap` to link packages.
  </action>
  <verify>
```bash
cd /Users/jay/Codes/jljm/jljm-phonesync
melos bootstrap
cd apps/desktop_client && flutter analyze
```
No errors.
  </verify>
  <done>Desktop app created, dependencies installed, builds for Windows and Mac without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Implement discovery and pairing services</name>
  <files>
    apps/desktop_client/lib/services/discovery_service.dart
    apps/desktop_client/lib/services/sync_service.dart
    apps/desktop_client/lib/services/session_storage.dart
    apps/desktop_client/lib/providers/discovery_provider.dart
    apps/desktop_client/lib/providers/session_provider.dart
    apps/desktop_client/lib/models/device.dart
  </files>
  <action>
Create DiscoveryService (apps/desktop_client/lib/services/discovery_service.dart):
- Use nsd package to discover `_phonesync._tcp` services
- Enable IP lookup with `IpLookupType.any`
- Return list of discovered devices with name, host, port
- Support manual IP:port entry fallback
- Emit device list changes via callback

Create Device model (apps/desktop_client/lib/models/device.dart):
- Fields: name, host, port
- fromService factory for nsd Service conversion

Create SyncService (apps/desktop_client/lib/services/sync_service.dart):
- Accept baseUrl and optional sessionToken in constructor
- Configure Dio with:
  - connectTimeout: 10 seconds
  - receiveTimeout: 5 minutes (large datasets)
  - Authorization header if token provided
- Configure self-signed certificate trust:
```dart
(_dio.httpClientAdapter as IOHttpClientAdapter).createHttpClient = () {
  final client = HttpClient();
  client.badCertificateCallback = (cert, host, port) => true;
  return client;
};
```
- Method: `pair(String pin)` -> POST /pair -> returns session token or throws
- Methods for data endpoints (fetchContacts, fetchSms, fetchCalls) - implement stubs returning empty for now, full implementation in Plan 02

Create SessionStorage (apps/desktop_client/lib/services/session_storage.dart):
- Use flutter_secure_storage
- Store: sessionToken, deviceName, deviceHost, devicePort
- Methods: saveSession, loadSession, clearSession
- Use record return type for loadSession

Create DiscoveryProvider (apps/desktop_client/lib/providers/discovery_provider.dart):
- StateNotifier with list of discovered devices
- isDiscovering flag
- Methods: startDiscovery, stopDiscovery, addManualDevice

Create SessionProvider (apps/desktop_client/lib/providers/session_provider.dart):
- StateNotifier with session state (token, device info, isPaired)
- Load session on init
- Methods: pair(device, pin), unpair
  </action>
  <verify>
```bash
cd /Users/jay/Codes/jljm/jljm-phonesync/apps/desktop_client && flutter analyze
```
No errors.
  </verify>
  <done>Discovery service finds devices via mDNS, sync service handles HTTPS with self-signed certs, session persists in secure storage.</done>
</task>

<task type="auto">
  <name>Task 3: Build discovery and pairing UI screens</name>
  <files>
    apps/desktop_client/lib/screens/discovery_screen.dart
    apps/desktop_client/lib/screens/pairing_screen.dart
    apps/desktop_client/lib/widgets/pin_input.dart
    apps/desktop_client/lib/widgets/device_card.dart
  </files>
  <action>
Create DeviceCard widget (apps/desktop_client/lib/widgets/device_card.dart):
- Modern/minimal card design (subtle shadow, rounded corners)
- Display device name and host:port
- Tap handler for selection
- Visual feedback on hover (desktop)

Create PinInput widget (apps/desktop_client/lib/widgets/pin_input.dart):
- Use pinput package
- 6 digits, auto-advance on each digit
- Modern theme: rounded boxes, subtle borders, blue accent on focus
- onCompleted callback when all 6 digits entered
- autofocus: true for immediate typing

Create DiscoveryScreen (apps/desktop_client/lib/screens/discovery_screen.dart):
- On mount: start mDNS discovery via provider
- Show "Searching for devices..." with progress indicator while discovering
- Show list of DeviceCards when devices found
- If no devices after 5 seconds, show "Manual entry" option with TextField for IP:port
- On device select: navigate to PairingScreen with device info
- Check for existing session on mount: if paired device found and online, auto-navigate to home

Create PairingScreen (apps/desktop_client/lib/screens/pairing_screen.dart):
- Display device name being paired with
- Large instructions: "Enter the PIN shown on your phone"
- PinInput widget for 6-digit entry
- On PIN complete: call sessionProvider.pair(device, pin)
- Show loading while pairing
- On success: save session, navigate to HomeScreen
- On failure: show error "Invalid or expired PIN", clear input

Update app.dart:
- Define routes: /discovery, /pairing, /home
- Initial route: /discovery (session check happens there)

Create placeholder HomeScreen (apps/desktop_client/lib/screens/home_screen.dart):
- Simple screen with "Paired with {device.name}" text
- "Unpair" button that clears session and returns to discovery
- Full implementation in Plan 02
  </action>
  <verify>
```bash
cd /Users/jay/Codes/jljm/jljm-phonesync/apps/desktop_client && flutter analyze
# Verify Windows build compiles
flutter build windows
# Test on macOS for full functionality
flutter run -d macos
```
App launches, shows discovery screen, can navigate to pairing. Windows build completes successfully.
  </verify>
  <done>Discovery screen shows devices, PIN entry has auto-advance, successful pairing navigates to home, session persists across restart. Both Windows and macOS builds verified.</done>
</task>

</tasks>

<verification>
1. `melos bootstrap` succeeds
2. `flutter analyze` in desktop_client passes
3. Windows build: `flutter build windows` completes without errors
4. App launches on macOS: `flutter run -d macos`
5. Discovery screen appears on launch
6. Manual IP entry works when no devices found
7. PIN entry has 6 boxes with auto-advance
8. After pairing (with running Android server), app shows home screen
9. Restart app: auto-connects to paired device if online
</verification>

<success_criteria>
- Desktop app builds for Windows and macOS without errors
- mDNS discovers Android devices advertising _phonesync._tcp
- Manual IP:port fallback available
- 6-digit PIN entry with auto-advance between boxes
- Successful pairing stores session token securely
- App remembers session and auto-connects on next launch
- Modern/minimal UI (clean cards, subtle shadows)
</success_criteria>

<output>
After completion, create `.planning/phases/03-desktop-client-export/03-01-SUMMARY.md`
</output>
