---
phase: 03-desktop-client-export
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/desktop_client/pubspec.yaml
  - apps/desktop_client/lib/database/database.dart
  - apps/desktop_client/lib/database/tables.dart
  - apps/desktop_client/lib/services/sync_service.dart
  - apps/desktop_client/lib/services/phone_normalizer.dart
  - apps/desktop_client/lib/services/export_service.dart
  - apps/desktop_client/lib/repositories/phone_repository.dart
  - apps/desktop_client/lib/providers/sync_provider.dart
  - apps/desktop_client/lib/providers/export_provider.dart
  - apps/desktop_client/lib/screens/home_screen.dart
  - apps/desktop_client/lib/widgets/sync_progress.dart
autonomous: true

must_haves:
  truths:
    - "Synced phone data persists in local SQLite database"
    - "Korean phone numbers are normalized to digits only (e.g., '01012345678')"
    - "International (non-Korean) phone numbers are normalized to E.164 format"
    - "Duplicate phone numbers across sources are merged into single row"
    - "User can export to Excel with Korean mobile filter option"
    - "Export handles 50,000+ rows without UI freeze"
    - "Progress shows during sync: 'Syncing contacts... 15,000 / 50,000'"
  artifacts:
    - path: "apps/desktop_client/lib/database/database.dart"
      provides: "Drift database with phone_entries table"
      contains: "@DriftDatabase"
    - path: "apps/desktop_client/lib/services/phone_normalizer.dart"
      provides: "Digits-only for Korean, E.164 for international numbers"
      exports: ["PhoneNormalizer"]
    - path: "apps/desktop_client/lib/services/export_service.dart"
      provides: "Excel export with isolate for large datasets"
      exports: ["ExportService"]
    - path: "apps/desktop_client/lib/screens/home_screen.dart"
      provides: "Main UI with sync button, progress, export button"
      min_lines: 100
  key_links:
    - from: "apps/desktop_client/lib/providers/sync_provider.dart"
      to: "SyncService"
      via: "HTTP fetch and database upsert"
      pattern: "fetchContacts|fetchSms|fetchCalls"
    - from: "apps/desktop_client/lib/services/export_service.dart"
      to: "Isolate"
      via: "Background Excel generation"
      pattern: "Isolate\\.run"
    - from: "apps/desktop_client/lib/screens/home_screen.dart"
      to: "export_provider"
      via: "Export button triggers export"
      pattern: "exportToExcel"
---

<objective>
Implement data sync with local storage, phone number normalization/deduplication, and Excel export with Korean mobile filter.

Purpose: Delivers the core value - synced phone data exportable to Excel on demand without re-syncing.

Output: Complete desktop app that syncs from Android, stores locally, and exports deduplicated/normalized phone numbers to Excel.
</objective>

<execution_context>
@/Users/jay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-desktop-client-export/03-CONTEXT.md
@.planning/phases/03-desktop-client-export/03-RESEARCH.md
@.planning/phases/03-desktop-client-export/03-01-SUMMARY.md

# API response formats from Android:
# GET /contacts: {"data": [{"displayName": "...", "phones": [{"number": "010-1234-5678"}]}], "count": N, "timestamp": T}
# GET /sms: {"data": [{"address": "010-1234-5678", "date": 123456789, "type": "inbox"}], "count": N, "timestamp": T}
# GET /calls: {"data": [{"number": "010-1234-5678", "name": "...", "timestamp": 123456789}], "count": N, "timestamp": T}
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Drift database with phone entries table</name>
  <files>
    apps/desktop_client/pubspec.yaml
    apps/desktop_client/lib/database/tables.dart
    apps/desktop_client/lib/database/database.dart
    apps/desktop_client/lib/repositories/phone_repository.dart
  </files>
  <action>
Add Drift dependencies to pubspec.yaml:
```yaml
dependencies:
  drift: ^2.31.0
  sqlite3: ^2.9.4
  path: ^1.9.0
  # ... existing deps

dev_dependencies:
  drift_dev: ^2.31.0
  build_runner: ^2.4.15
  # ... existing deps
```

Create tables.dart (apps/desktop_client/lib/database/tables.dart):
```dart
import 'package:drift/drift.dart';

class PhoneEntries extends Table {
  // Normalized phone number - primary key
  // Korean: digits only (e.g., "01012345678")
  // International: E.164 format (e.g., "+15551234567")
  TextColumn get phoneNumber => text()();

  // Contact name if available (from contacts or call log)
  TextColumn get displayName => text().nullable()();

  // JSON array of sources: ["contact", "sms", "call"]
  TextColumn get sourceTypes => text()();

  // Earliest timestamp from all sources (milliseconds)
  IntColumn get firstSeen => integer().nullable()();

  // Latest timestamp from all sources (milliseconds)
  IntColumn get lastSeen => integer().nullable()();

  // JSON array of original raw number formats for debugging
  TextColumn get rawNumbers => text()();

  @override
  Set<Column> get primaryKey => {phoneNumber};
}

class SyncMetadata extends Table {
  TextColumn get key => text()();
  TextColumn get value => text()();

  @override
  Set<Column> get primaryKey => {key};
}
```

Create database.dart (apps/desktop_client/lib/database/database.dart):
```dart
import 'dart:io';
import 'package:drift/drift.dart';
import 'package:drift/native.dart';
import 'package:path_provider/path_provider.dart';
import 'package:path/path.dart' as p;
import 'tables.dart';

part 'database.g.dart';

@DriftDatabase(tables: [PhoneEntries, SyncMetadata])
class AppDatabase extends _$AppDatabase {
  AppDatabase() : super(_openConnection());

  @override
  int get schemaVersion => 1;

  static LazyDatabase _openConnection() {
    return LazyDatabase(() async {
      final dbFolder = await getApplicationDocumentsDirectory();
      final file = File(p.join(dbFolder.path, 'phonesync.db'));
      // Run in background isolate for performance with large datasets
      return NativeDatabase.createInBackground(file);
    });
  }
}
```

Create PhoneRepository (apps/desktop_client/lib/repositories/phone_repository.dart):
- Wrapper around AppDatabase for phone entry operations
- Method: upsertPhoneEntry(normalized, name, sources, firstSeen, lastSeen, rawNumbers)
  - Use insertOnConflictUpdate
  - On conflict: merge sourceTypes arrays, update timestamps (min firstSeen, max lastSeen), append rawNumbers
- Method: getAllEntries({bool koreanMobileOnly = true})
  - If koreanMobileOnly: filter where phoneNumber LIKE '010%' (Korean mobile digits-only format)
  - Return list of PhoneEntry
- Method: getEntryCount() -> int
- Method: clearAllEntries() for re-sync
- Method: getSyncTimestamp(key), setSyncTimestamp(key, value) using SyncMetadata table

Run build_runner:
```bash
cd /Users/jay/Codes/jljm/jljm-phonesync/apps/desktop_client
dart run build_runner build --delete-conflicting-outputs
```
  </action>
  <verify>
```bash
cd /Users/jay/Codes/jljm/jljm-phonesync/apps/desktop_client
dart run build_runner build --delete-conflicting-outputs
flutter analyze
```
Generated database.g.dart exists, no analysis errors.
  </verify>
  <done>Drift database configured with phone_entries and sync_metadata tables, repository handles upsert with deduplication.</done>
</task>

<task type="auto">
  <name>Task 2: Implement phone normalizer and sync service with progress</name>
  <files>
    apps/desktop_client/lib/services/phone_normalizer.dart
    apps/desktop_client/lib/services/sync_service.dart
    apps/desktop_client/lib/providers/sync_provider.dart
  </files>
  <action>
Create PhoneNormalizer (apps/desktop_client/lib/services/phone_normalizer.dart):

IMPORTANT: Per user decision, Korean numbers use digits-only format, NOT E.164.
- Korean numbers: strip to digits only (e.g., "010-1234-5678" -> "01012345678")
- International numbers: E.164 format (e.g., "+1-555-1234" -> "+15551234")

```dart
class PhoneNormalizer {
  /// Normalize phone number
  /// Korean: digits only (e.g., "01012345678")
  /// International: E.164 format (e.g., "+15551234567")
  String? normalize(String rawNumber) {
    // Strip all non-digit characters except leading +
    final cleaned = rawNumber.replaceAll(RegExp(r'[^\d+]'), '');

    if (cleaned.isEmpty) return null;

    // Already has country code (international)
    if (cleaned.startsWith('+')) {
      // Check if it's a Korean number with country code
      if (cleaned.startsWith('+82')) {
        // Convert +8210... to 010... (digits only for Korean)
        final withoutCountry = cleaned.substring(3);
        if (withoutCountry.startsWith('10')) {
          return '0$withoutCountry'; // +821012345678 -> 01012345678
        }
        // Other Korean numbers (landlines): 0 + rest
        return '0$withoutCountry';
      }
      // Non-Korean international: keep E.164 format
      return cleaned;
    }

    // Korean domestic mobile (010-xxxx-xxxx) - digits only
    if (cleaned.startsWith('010') && cleaned.length >= 10) {
      return cleaned; // Already digits only: 01012345678
    }

    // Korean domestic with area code (02-xxxx-xxxx, etc.) - digits only
    if (cleaned.startsWith('0') && cleaned.length >= 9) {
      return cleaned; // Keep as digits: 0212345678
    }

    // Unknown format - return as-is if reasonable length
    if (cleaned.length >= 7 && cleaned.length <= 15) {
      return cleaned;
    }

    return null; // Invalid or unrecognized format
  }

  /// Check if normalized number is Korean mobile (010 prefix)
  /// Works with digits-only format
  bool isKoreanMobile(String normalizedNumber) {
    return normalizedNumber.startsWith('010');
  }
}
```

Update SyncService (apps/desktop_client/lib/services/sync_service.dart):
- Add PhoneNormalizer instance
- Implement fetchContacts() with progress callback:
  - GET /contacts
  - Parse response.data['data'] as List
  - Return raw JSON list for processing
- Implement fetchSms(sinceTimestamp) with progress:
  - GET /sms?since={timestamp} (if timestamp provided)
  - Return raw JSON list
- Implement fetchCalls(sinceTimestamp) with progress:
  - GET /calls?since={timestamp}
  - Return raw JSON list
- All methods use onReceiveProgress callback from Dio

Create SyncProvider (apps/desktop_client/lib/providers/sync_provider.dart):
State class:
```dart
class SyncState {
  final bool isSyncing;
  final String currentPhase; // 'contacts', 'sms', 'calls', 'idle'
  final int currentCount;
  final int totalCount;
  final String? error;
  final DateTime? lastSyncTime;
}
```

SyncNotifier extends StateNotifier<SyncState>:
- Inject SyncService, PhoneRepository
- Method: syncAll()
  1. Set isSyncing = true, phase = 'contacts'
  2. Fetch contacts, process each:
     - Extract phone numbers from contact.phones
     - Normalize each number (digits only for Korean, E.164 for international)
     - Upsert to database with source='contact', name from displayName
     - Update progress (currentCount/totalCount)
  3. Get last SMS sync timestamp from repository
  4. Set phase = 'sms', fetch SMS since timestamp
  5. Process each SMS: normalize address, upsert with source='sms', timestamp from date
  6. Save new SMS sync timestamp
  7. Repeat for calls (phase = 'calls')
  8. Set isSyncing = false, update lastSyncTime

Handle errors: catch, set error message, set isSyncing = false

Deduplication logic (in upsert):
- If number exists: merge sources array, take non-null name, update firstSeen/lastSeen
- If new: insert with single source
  </action>
  <verify>
```bash
cd /Users/jay/Codes/jljm/jljm-phonesync/apps/desktop_client && flutter analyze
```
No errors.
  </verify>
  <done>Phone normalizer converts Korean numbers to digits-only and international numbers to E.164, sync service fetches with progress, provider handles full sync flow with deduplication.</done>
</task>

<task type="auto">
  <name>Task 3: Implement export service and complete home screen UI</name>
  <files>
    apps/desktop_client/pubspec.yaml
    apps/desktop_client/lib/services/export_service.dart
    apps/desktop_client/lib/providers/export_provider.dart
    apps/desktop_client/lib/screens/home_screen.dart
    apps/desktop_client/lib/widgets/sync_progress.dart
  </files>
  <action>
Add excel and intl dependencies to pubspec.yaml:
```yaml
dependencies:
  excel: ^4.0.6
  intl: ^0.19.0
  file_picker: ^10.3.10
  # ... existing
```

Create ExportService (apps/desktop_client/lib/services/export_service.dart):
```dart
import 'dart:io';
import 'dart:isolate';
import 'package:excel/excel.dart';
import 'package:intl/intl.dart';

class ExportService {
  /// Export phone entries to Excel file
  /// Runs in isolate to prevent UI freeze on large datasets
  Future<void> exportToExcel({
    required List<Map<String, dynamic>> entries,
    required String filePath,
    void Function(int current, int total)? onProgress,
  }) async {
    // Run in isolate for 50k+ rows
    await Isolate.run(() {
      final excel = Excel.createExcel();
      final sheet = excel['Phone Numbers'];

      // Header row
      sheet.appendRow([
        TextCellValue('Phone Number'),
        TextCellValue('Name'),
        TextCellValue('Sources'),
        TextCellValue('First Seen'),
        TextCellValue('Last Seen'),
      ]);

      // Data rows
      for (final entry in entries) {
        final firstSeen = entry['firstSeen'] as int?;
        final lastSeen = entry['lastSeen'] as int?;

        sheet.appendRow([
          TextCellValue(entry['phoneNumber'] as String),
          TextCellValue(entry['displayName'] as String? ?? ''),
          TextCellValue(entry['sourceTypes'] as String),
          firstSeen != null
              ? DateTimeCellValue.fromDateTime(
                  DateTime.fromMillisecondsSinceEpoch(firstSeen))
              : TextCellValue(''),
          lastSeen != null
              ? DateTimeCellValue.fromDateTime(
                  DateTime.fromMillisecondsSinceEpoch(lastSeen))
              : TextCellValue(''),
        ]);
      }

      // Remove default Sheet1
      excel.delete('Sheet1');

      // Save
      final bytes = excel.save()!;
      File(filePath).writeAsBytesSync(bytes);
    });
  }

  /// Generate filename: {DeviceName}_{YYYY-MM-DD}_{HHMMSS}.xlsx
  String generateFilename(String deviceName) {
    final now = DateTime.now();
    final date = DateFormat('yyyy-MM-dd').format(now);
    final time = DateFormat('HHmmss').format(now);
    final safeName = deviceName.replaceAll(RegExp(r'[^\w\s-]'), '').trim();
    return '${safeName}_${date}_$time.xlsx';
  }
}
```

Create ExportProvider (apps/desktop_client/lib/providers/export_provider.dart):
State:
```dart
class ExportState {
  final bool isExporting;
  final bool koreanMobileOnly; // Default: true
  final String? lastExportPath;
  final String? error;
}
```

ExportNotifier:
- Inject ExportService, PhoneRepository
- Method: setKoreanMobileFilter(bool)
- Method: export(deviceName)
  1. Get entries from repository (with filter using LIKE '010%' for Korean mobile)
  2. Show file save dialog with generated filename
  3. If path selected: export to file
  4. Update lastExportPath

Create SyncProgress widget (apps/desktop_client/lib/widgets/sync_progress.dart):
- Display: "Syncing {phase}... {current} / {total}"
- Linear progress bar
- Modern/minimal style (subtle colors)

Update HomeScreen (apps/desktop_client/lib/screens/home_screen.dart):
Complete implementation with modern/minimal design:

Layout (centered card-based):
1. Header: "PhoneSync" title, paired device name, "Unpair" text button
2. Stats card:
   - Total phone numbers count
   - Last sync time
3. Sync section:
   - "Sync Now" button (disabled while syncing)
   - SyncProgress widget when syncing
4. Export section:
   - Switch: "Korean mobile only (010)" - default ON
   - "Export to Excel" button
   - Show last export path if exists
5. Error display if any

Styling:
- Clean white background
- Cards with subtle shadow (elevation: 2)
- Blue accent color
- Spacious padding (24px)
- Inter or system font

Wire up providers:
- Watch syncProvider for sync state
- Watch exportProvider for export state
- Watch sessionProvider for device info
- Unpair: clear session, navigate to discovery
  </action>
  <verify>
```bash
cd /Users/jay/Codes/jljm/jljm-phonesync/apps/desktop_client && flutter analyze
# Verify Windows build compiles
flutter build windows
# Test on macOS for full functionality
flutter run -d macos
```
App builds for both platforms, home screen shows, sync and export buttons work.
  </verify>
  <done>Excel export runs in isolate, filename follows format, home screen shows sync progress and export with Korean filter toggle. Both Windows and macOS builds verified.</done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes in desktop_client
2. Build_runner generates database.g.dart
3. Windows build: `flutter build windows` completes without errors
4. App syncs from Android device:
   - Progress shows "Syncing contacts... X / Y"
   - Phone numbers stored in local database
5. Phone numbers normalized correctly:
   - Korean "010-1234-5678" becomes "01012345678" (digits only)
   - International "+1-555-1234" becomes "+15551234" (E.164)
   - Duplicates merged with combined sources
6. Export works:
   - File save dialog appears
   - Filename format: {Device}_{YYYY-MM-DD}_{HHMMSS}.xlsx
   - Excel opens with correct columns
7. Korean mobile filter:
   - ON (default): only 010* numbers (digits-only format)
   - OFF: all numbers
8. 50k+ rows: UI remains responsive during export
9. App restart: data still in database, can export without re-sync
</verification>

<success_criteria>
- Drift database stores phone entries with deduplication
- Sync shows progress: "Syncing {phase}... {current} / {total}"
- Korean phone numbers normalized to digits only (e.g., "01012345678")
- International phone numbers normalized to E.164 format
- Duplicates merged: one row per number, sources combined
- Excel export columns: Phone Number, Name, Sources, First Seen, Last Seen
- Filename: {DeviceName}_{YYYY-MM-DD}_{HHMMSS}.xlsx
- Korean mobile filter ON by default, can toggle OFF
- Export runs in isolate (no UI freeze on large datasets)
- Modern/minimal UI with clean cards and subtle shadows
- Builds successfully on both Windows and macOS
</success_criteria>

<output>
After completion, create `.planning/phases/03-desktop-client-export/03-02-SUMMARY.md`
</output>
