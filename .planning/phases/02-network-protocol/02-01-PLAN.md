---
phase: 02-network-protocol
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/android_provider/pubspec.yaml
  - apps/android_provider/lib/services/server/http_server.dart
  - apps/android_provider/lib/services/server/routes.dart
  - apps/android_provider/lib/services/server/handlers/contacts_handler.dart
  - apps/android_provider/lib/services/server/handlers/sms_handler.dart
  - apps/android_provider/lib/services/server/handlers/calls_handler.dart
  - apps/android_provider/lib/services/discovery_service.dart
  - apps/android_provider/lib/providers/server_provider.dart
  - apps/android_provider/android/app/src/main/AndroidManifest.xml
autonomous: true

must_haves:
  truths:
    - "HTTP server starts and listens on a port"
    - "Server responds to GET /contacts, /sms, /calls with JSON"
    - "mDNS service is advertised on local network with _phonesync._tcp type"
    - "Server port is dynamically assigned and advertised via mDNS"
  artifacts:
    - path: "apps/android_provider/lib/services/server/http_server.dart"
      provides: "Shelf HTTP server class with start/stop methods"
      contains: "shelf_io.serve"
    - path: "apps/android_provider/lib/services/server/routes.dart"
      provides: "Router configuration for /contacts, /sms, /calls"
      contains: "Router"
    - path: "apps/android_provider/lib/services/discovery_service.dart"
      provides: "mDNS registration/unregistration"
      contains: "nsd"
    - path: "apps/android_provider/lib/providers/server_provider.dart"
      provides: "Server state management"
      contains: "StateNotifier"
  key_links:
    - from: "apps/android_provider/lib/services/server/routes.dart"
      to: "services/*_service.dart"
      via: "service method calls in handlers"
      pattern: "ContactsService|SmsService|CallLogService"
    - from: "apps/android_provider/lib/services/server/http_server.dart"
      to: "apps/android_provider/lib/services/discovery_service.dart"
      via: "advertise after server starts"
      pattern: "discoveryService.advertise"
---

<objective>
Create HTTP server on Android that serves phone data endpoints and advertises via mDNS for desktop discovery.

Purpose: Enable desktop clients to discover and connect to the Android device on the local network without manual IP entry.
Output: Working HTTP server with /contacts, /sms, /calls endpoints, advertised via mDNS as _phonesync._tcp service.
</objective>

<execution_context>
@/Users/jay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-network-protocol/02-RESEARCH.md

# Phase 1 outputs - data extraction services
@apps/android_provider/lib/services/contacts_service.dart
@apps/android_provider/lib/services/sms_service.dart
@apps/android_provider/lib/services/call_log_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add network dependencies and Android permissions</name>
  <files>
    apps/android_provider/pubspec.yaml
    apps/android_provider/android/app/src/main/AndroidManifest.xml
  </files>
  <action>
Add network-related dependencies to pubspec.yaml:
- shelf: ^1.4.2 (HTTP server framework)
- shelf_router: ^1.1.4 (routing)
- nsd: ^4.1.0 (mDNS discovery/registration)

Note: basic_utils and pointycastle for TLS are added in Plan 02.

Add network permissions to AndroidManifest.xml (before application tag):
- android.permission.INTERNET (already present for debug but add explicitly)
- android.permission.ACCESS_WIFI_STATE (for mDNS)
- android.permission.CHANGE_WIFI_MULTICAST_STATE (for mDNS)
  </action>
  <verify>
cd /Users/jay/Codes/jljm/jljm-phonesync/apps/android_provider && flutter pub get succeeds
  </verify>
  <done>
Dependencies installed, network permissions declared in manifest
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HTTP server with shelf and data endpoints</name>
  <files>
    apps/android_provider/lib/services/server/http_server.dart
    apps/android_provider/lib/services/server/routes.dart
    apps/android_provider/lib/services/server/handlers/contacts_handler.dart
    apps/android_provider/lib/services/server/handlers/sms_handler.dart
    apps/android_provider/lib/services/server/handlers/calls_handler.dart
    apps/android_provider/lib/providers/server_provider.dart
  </files>
  <action>
Create server directory structure under lib/services/server/.

**http_server.dart:**
- PhoneSyncServer class with start(port) and stop() methods
- Use shelf_io.serve with InternetAddress.anyIPv4
- Use port 0 for dynamic port assignment, expose actual port via getter
- Store HttpServer reference for proper shutdown
- Integrate with routes.dart for request handling

**routes.dart:**
- Create Router with GET /contacts, GET /sms, GET /calls endpoints
- Each endpoint delegates to its handler
- Support ?since= query parameter for incremental sync (timestamp in milliseconds)
- Return JSON responses with Content-Type: application/json header

**handlers/contacts_handler.dart:**
- handleContacts(Request request, ContactsService service) -> Response
- Parse ?since= query param (optional, milliseconds since epoch)
- Call service.extractContacts() (contacts don't have timestamp filtering)
- Return JSON: {data: [...], count: N, timestamp: now}

**handlers/sms_handler.dart:**
- handleSms(Request request, SmsService service) -> Response
- Parse ?since= query param (optional, milliseconds since epoch)
- Call service.extractSmsNumbers(sinceTimestamp: since)
- Return JSON: {data: [...], count: N, timestamp: now}

**handlers/calls_handler.dart:**
- handleCalls(Request request, CallLogService service) -> Response
- Parse ?since= query param (optional, milliseconds since epoch)
- Call service.extractCallLogNumbers(sinceTimestamp: since)
- Return JSON: {data: [...], count: N, timestamp: now}

**providers/server_provider.dart:**
- ServerState: isRunning, port, error
- ServerNotifier extends StateNotifier<ServerState>
- startServer() and stopServer() methods
- serverProvider for Riverpod access

Note: Authentication will be added in Plan 02. For now, endpoints are open.
  </action>
  <verify>
flutter analyze in apps/android_provider shows no errors for new files
  </verify>
  <done>
HTTP server class created with /contacts, /sms, /calls endpoints returning JSON data from existing extraction services
  </done>
</task>

<task type="auto">
  <name>Task 3: Create mDNS service advertisement</name>
  <files>
    apps/android_provider/lib/services/discovery_service.dart
  </files>
  <action>
Create DiscoveryService class using nsd package:

**discovery_service.dart:**
- advertise({required String deviceName, required int port}) method
  - Create Service with:
    - name: deviceName (will use device model or "PhoneSync-{short_id}")
    - type: '_phonesync._tcp' (custom service type for our protocol)
    - port: the actual server port
    - txt: {'version': '1.0', 'device': deviceName} encoded as Uint8List
  - Call nsd.register(service) and store Registration reference
  - Handle name conflicts (Android may rename to "PhoneSync (1)")

- stopAdvertising() method
  - Call nsd.unregister(registration) if registration exists
  - Set registration to null

- getDeviceName() helper
  - For now, return "PhoneSync-Android" (device-specific ID can be added later)

Import: import 'package:nsd/nsd.dart';
Note: The nsd package's txt field expects Map<String, Uint8List>, so encode strings with utf8.encode.
  </action>
  <verify>
flutter analyze in apps/android_provider shows no errors
  </verify>
  <done>
mDNS service registration implemented, can advertise server on local network as _phonesync._tcp
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/jay/Codes/jljm/jljm-phonesync/apps/android_provider && flutter pub get` - Dependencies install
2. `flutter analyze` - No errors in new files
3. `flutter build apk --debug` - APK builds successfully with new permissions
4. Inspect AndroidManifest.xml - Network permissions present
</verification>

<success_criteria>
- shelf, shelf_router, nsd packages installed
- Network permissions declared in AndroidManifest.xml
- HTTP server class can start on dynamic port and serve /contacts, /sms, /calls
- Each endpoint returns JSON with data array, count, and timestamp
- mDNS service can be advertised with _phonesync._tcp type
- Server provider manages start/stop state
- APK builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/02-network-protocol/02-01-SUMMARY.md`
</output>
