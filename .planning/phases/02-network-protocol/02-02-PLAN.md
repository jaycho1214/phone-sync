---
phase: 02-network-protocol
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/android_provider/pubspec.yaml
  - apps/android_provider/lib/services/certificate_service.dart
  - apps/android_provider/lib/services/pairing_service.dart
  - apps/android_provider/lib/services/server/http_server.dart
  - apps/android_provider/lib/services/server/routes.dart
  - apps/android_provider/lib/services/server/handlers/pairing_handler.dart
  - apps/android_provider/lib/services/server/middleware/auth_middleware.dart
  - apps/android_provider/lib/providers/pairing_provider.dart
  - apps/android_provider/lib/screens/home_screen.dart
autonomous: true

must_haves:
  truths:
    - "Android displays a 6-digit PIN code on screen"
    - "Desktop can POST /pair with PIN to get session token"
    - "Data endpoints require valid session token (401 without)"
    - "Server uses HTTPS with self-signed TLS certificate"
    - "PIN expires after 5 minutes"
  artifacts:
    - path: "apps/android_provider/lib/services/certificate_service.dart"
      provides: "TLS certificate generation and persistence"
      contains: "SecurityContext"
    - path: "apps/android_provider/lib/services/pairing_service.dart"
      provides: "PIN generation and validation"
      contains: "generatePin"
    - path: "apps/android_provider/lib/services/server/handlers/pairing_handler.dart"
      provides: "POST /pair endpoint"
      contains: "handlePair"
    - path: "apps/android_provider/lib/services/server/middleware/auth_middleware.dart"
      provides: "Session token validation middleware"
      contains: "Authorization"
    - path: "apps/android_provider/lib/screens/home_screen.dart"
      provides: "PIN display UI"
      contains: "pin"
  key_links:
    - from: "apps/android_provider/lib/services/server/http_server.dart"
      to: "apps/android_provider/lib/services/certificate_service.dart"
      via: "SecurityContext for HTTPS"
      pattern: "securityContext"
    - from: "apps/android_provider/lib/services/server/middleware/auth_middleware.dart"
      to: "apps/android_provider/lib/services/pairing_service.dart"
      via: "session token validation"
      pattern: "isValidSession"
    - from: "apps/android_provider/lib/screens/home_screen.dart"
      to: "apps/android_provider/lib/providers/pairing_provider.dart"
      via: "watch pairing state for PIN display"
      pattern: "ref.watch.*pairingProvider"
---

<objective>
Add TLS encryption and PIN-based pairing to secure the HTTP server, with UI to display pairing PIN.

Purpose: Ensure only authorized desktop clients can access phone data, with encrypted transfer.
Output: HTTPS server with PIN pairing flow - Android shows PIN, desktop enters it, gets session token for subsequent requests.
</objective>

<execution_context>
@/Users/jay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-network-protocol/02-RESEARCH.md
@.planning/phases/02-network-protocol/02-01-SUMMARY.md

# From Plan 01
@apps/android_provider/lib/services/server/http_server.dart
@apps/android_provider/lib/services/server/routes.dart
@apps/android_provider/lib/providers/server_provider.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TLS certificate generation</name>
  <files>
    apps/android_provider/pubspec.yaml
    apps/android_provider/lib/services/certificate_service.dart
    apps/android_provider/lib/services/server/http_server.dart
  </files>
  <action>
Add TLS-related dependencies to pubspec.yaml:
- basic_utils: ^5.8.2 (X509 certificate generation)
- pointycastle: ^4.0.0 (RSA key generation, required by basic_utils)

**certificate_service.dart:**
Create CertificateService class:

- generateOrLoadCertificate() async method:
  - Check if certs exist in SharedPreferences (keys: 'tls_cert_pem', 'tls_key_pem')
  - If exist and not expired, return them
  - If not, generate new self-signed certificate:
    - Generate 2048-bit RSA key pair using CryptoUtils.generateRSAKeyPair()
    - Create CSR with CN='PhoneSync Device', O='JLJM PhoneSync'
    - Generate self-signed cert valid for 365 days
    - Store both PEM strings in SharedPreferences
  - Return (certPem: String, keyPem: String) record

- createSecurityContext(String certPem, String keyPem) method:
  - Create SecurityContext()
  - context.useCertificateChainBytes(utf8.encode(certPem))
  - context.usePrivateKeyBytes(utf8.encode(keyPem))
  - Return context

Note: Use basic_utils X509Utils and CryptoUtils as shown in RESEARCH.md Pattern 4.

**http_server.dart (modify):**
- Update start() to accept optional SecurityContext parameter
- Pass securityContext to shelf_io.serve() for HTTPS
- If securityContext is null, fall back to HTTP (for testing)
  </action>
  <verify>
flutter analyze in apps/android_provider shows no errors
  </verify>
  <done>
TLS certificate generation working, server can start with HTTPS using SecurityContext
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement PIN pairing and session token authentication</name>
  <files>
    apps/android_provider/lib/services/pairing_service.dart
    apps/android_provider/lib/services/server/handlers/pairing_handler.dart
    apps/android_provider/lib/services/server/middleware/auth_middleware.dart
    apps/android_provider/lib/services/server/routes.dart
    apps/android_provider/lib/providers/pairing_provider.dart
  </files>
  <action>
**pairing_service.dart:**
Create PairingService class:

- generatePin() -> String: Generate 6-digit numeric PIN using Random.secure()
- generateSessionToken() -> String: Generate 32-char hex token using Random.secure()
- PairingState class with:
  - pin: String (6 digits)
  - expiresAt: DateTime (now + 5 minutes)
  - sessionToken: String? (null until paired)
  - pairedAt: DateTime? (when pairing succeeded)
- isValidPin(String submitted) -> bool: Check pin matches and not expired
- isValidSession(String token) -> bool: Check token matches stored sessionToken

**handlers/pairing_handler.dart:**
- handlePair(Request request, PairingService service) -> Response
- Parse JSON body: {"pin": "123456"}
- If pin invalid or expired: return 401 {"error": "Invalid or expired PIN"}
- If valid: generate session token, store in service, return 200 {"status": "paired", "sessionToken": "..."}

**middleware/auth_middleware.dart:**
- createAuthMiddleware(PairingService service) -> Middleware
- Check Authorization header: "Bearer {sessionToken}"
- If missing or invalid: return 401 {"error": "Unauthorized"}
- If valid: call next handler
- Exempt /pair endpoint from auth check (it's how you GET a token)

**routes.dart (modify):**
- Add POST /pair route using pairing_handler
- Wrap /contacts, /sms, /calls with auth middleware
- Leave /pair unauthenticated

**providers/pairing_provider.dart:**
- PairingState: pin, expiresAt, isPaired, sessionToken (expose only what UI needs)
- PairingNotifier extends StateNotifier<PairingState>
- generateNewPin() - creates new PIN valid for 5 minutes
- pair(String token) - called when pairing succeeds
- reset() - clears pairing state
- pairingProvider for Riverpod access
  </action>
  <verify>
flutter analyze in apps/android_provider shows no errors
  </verify>
  <done>
PIN pairing implemented: /pair accepts PIN, returns session token; data endpoints require valid Authorization header
  </done>
</task>

<task type="auto">
  <name>Task 3: Add pairing UI to home screen</name>
  <files>
    apps/android_provider/lib/screens/home_screen.dart
  </files>
  <action>
Modify HomeScreen to add server/pairing section:

Add a new Card below the existing permission/extraction UI:

**Server Status Card:**
- Show server running/stopped status (from serverProvider)
- If running: show port number and "Discoverable on network"
- Start Server / Stop Server button

**Pairing Section (when server is running):**
- Display current PIN in large, readable font (e.g., TextStyle fontSize: 48, letterSpacing: 8)
- Show PIN expiration countdown (e.g., "Expires in 4:32")
- "Generate New PIN" button
- If paired: show "Paired" indicator with green checkmark
- Show session info: "Connected device" or "Waiting for pairing..."

**Layout:**
- Existing content (permissions, extraction) remains at top
- New server/pairing card below
- Use ExpansionTile or similar if screen gets crowded

**State integration:**
- ref.watch(serverProvider) for server state
- ref.watch(pairingProvider) for PIN and pairing state
- ref.read(serverProvider.notifier).startServer() / stopServer()
- ref.read(pairingProvider.notifier).generateNewPin()
  </action>
  <verify>
flutter analyze in apps/android_provider shows no errors
flutter build apk --debug succeeds
  </verify>
  <done>
Home screen shows server status, PIN code, pairing state; user can start/stop server and generate new PIN
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/jay/Codes/jljm/jljm-phonesync/apps/android_provider && flutter pub get` - Dependencies install
2. `flutter analyze` - No errors in new/modified files
3. `flutter build apk --debug` - APK builds successfully
4. Code inspection: /pair endpoint exists and not protected by auth middleware
5. Code inspection: /contacts, /sms, /calls are protected by auth middleware
</verification>

<success_criteria>
- basic_utils and pointycastle packages installed
- TLS certificate generation works and persists in SharedPreferences
- HTTP server can start with HTTPS using generated certificate
- 6-digit PIN generation with 5-minute expiry
- POST /pair accepts PIN, returns session token
- Data endpoints return 401 without valid Authorization header
- Data endpoints work with valid "Bearer {token}" header
- Home screen displays PIN prominently with expiration countdown
- Start/Stop Server button works
- Generate New PIN button works
- Paired status visible in UI
</success_criteria>

<output>
After completion, create `.planning/phases/02-network-protocol/02-02-SUMMARY.md`
</output>
