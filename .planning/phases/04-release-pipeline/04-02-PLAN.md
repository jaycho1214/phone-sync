---
phase: 04-release-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - .github/workflows/release.yml
autonomous: true

must_haves:
  truths:
    - "Pushing a v*.*.* tag triggers automated builds for all 4 platforms"
    - "All platform builds run in parallel"
    - "GitHub Release is created with APK, macOS zip, Windows zip, Linux tar.gz"
    - "Each artifact has SHA256 checksum"
    - "Android APK is signed with release keystore from secrets"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Multi-platform release workflow"
      contains: "v*.*.*"
    - path: ".github/workflows/release.yml"
      provides: "Parallel platform jobs"
      contains: "build-android"
    - path: ".github/workflows/release.yml"
      provides: "Release creation"
      contains: "softprops/action-gh-release"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "GitHub Secrets"
      via: "secrets.KEYSTORE_BASE64 reference"
      pattern: "secrets\\.KEYSTORE"
    - from: ".github/workflows/release.yml"
      to: "apps/android_provider"
      via: "working-directory"
      pattern: "working-directory.*android_provider"
    - from: "create-release job"
      to: "build jobs"
      via: "needs array"
      pattern: "needs:.*build-android.*build-macos"
---

<objective>
Create GitHub Actions workflow for multi-platform release builds

Purpose: Automate the entire release process - push a version tag, get signed builds for all 4 platforms with checksums uploaded to GitHub Releases.
Output: .github/workflows/release.yml with parallel build jobs and release creation
</objective>

<execution_context>
@/Users/jay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-release-pipeline/04-RESEARCH.md
@.planning/phases/04-release-pipeline/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Multi-Platform Release Workflow</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create `.github/workflows/release.yml` with the following structure:

```yaml
name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  FLUTTER_VERSION: stable

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Decode Keystore
        working-directory: apps/android_provider/android
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > app/upload-keystore.jks

      - name: Create key.properties
        working-directory: apps/android_provider/android
        run: |
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> key.properties
          echo "storeFile=upload-keystore.jks" >> key.properties

      - name: Build APK
        working-directory: apps/android_provider
        run: flutter build apk --release --build-name=${{ steps.version.outputs.VERSION }}

      - name: Rename APK
        run: |
          mv apps/android_provider/build/app/outputs/flutter-apk/app-release.apk \
             android_provider-${{ steps.version.outputs.VERSION }}.apk

      - uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: android_provider-${{ steps.version.outputs.VERSION }}.apk

  build-macos:
    runs-on: macos-14  # NOT macos-15 due to certificate issues
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Build macOS
        working-directory: apps/desktop_client
        run: flutter build macos --release --build-name=${{ steps.version.outputs.VERSION }}

      - name: Create ZIP
        run: |
          cd apps/desktop_client/build/macos/Build/Products/Release
          zip -r ../../../../../../desktop_client-macos-${{ steps.version.outputs.VERSION }}.zip desktop_client.app

      - uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: apps/desktop_client/desktop_client-macos-${{ steps.version.outputs.VERSION }}.zip

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Build Windows
        working-directory: apps/desktop_client
        run: flutter build windows --release --build-name=${{ steps.version.outputs.VERSION }}

      - name: Create ZIP
        shell: pwsh
        run: |
          Compress-Archive -Path "apps/desktop_client/build/windows/x64/runner/Release/*" `
            -DestinationPath "desktop_client-windows-${{ steps.version.outputs.VERSION }}.zip"

      - uses: actions/upload-artifact@v4
        with:
          name: windows-app
          path: desktop_client-windows-${{ steps.version.outputs.VERSION }}.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Install Linux dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev libstdc++-12-dev

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Build Linux
        working-directory: apps/desktop_client
        run: flutter build linux --release --build-name=${{ steps.version.outputs.VERSION }}

      - name: Create tarball
        run: |
          cd apps/desktop_client/build/linux/x64/release
          tar -czvf ../../../../desktop_client-linux-${{ steps.version.outputs.VERSION }}.tar.gz bundle/

      - uses: actions/upload-artifact@v4
        with:
          name: linux-app
          path: apps/desktop_client/desktop_client-linux-${{ steps.version.outputs.VERSION }}.tar.gz

  create-release:
    needs: [build-android, build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate checksums
        working-directory: artifacts
        run: sha256sum * > SHA256SUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/*
          generate_release_notes: true
          body: |
            ## PhoneSync ${{ steps.version.outputs.VERSION }}

            ### Downloads

            | Platform | File |
            |----------|------|
            | Android | `android_provider-${{ steps.version.outputs.VERSION }}.apk` |
            | macOS | `desktop_client-macos-${{ steps.version.outputs.VERSION }}.zip` |
            | Windows | `desktop_client-windows-${{ steps.version.outputs.VERSION }}.zip` |
            | Linux | `desktop_client-linux-${{ steps.version.outputs.VERSION }}.tar.gz` |

            ### Verification

            Verify downloads with `sha256sum -c SHA256SUMS.txt`
```

Key design decisions:
- macos-14 runner (NOT macos-15) to avoid certificate validation issues
- All build jobs run in parallel (no dependencies between platforms)
- create-release job waits for ALL builds via needs array
- Version extracted from tag (v1.0.0 -> 1.0.0) for artifact naming
- Flutter SDK cached on all runners for speed
- Working directories set for monorepo structure
  </action>
  <verify>
1. Verify file exists: `ls -la .github/workflows/release.yml`
2. Verify YAML is valid: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/release.yml'))"`
3. Verify structure:
   - Contains `on: push: tags: - 'v*.*.*'`
   - Contains jobs: build-android, build-macos, build-windows, build-linux, create-release
   - create-release has `needs: [build-android, build-macos, build-windows, build-linux]`
   - macos job uses `runs-on: macos-14`
  </verify>
  <done>
- release.yml triggers on v*.*.* tags
- 4 parallel build jobs (Android, macOS, Windows, Linux)
- Android job decodes keystore and creates key.properties
- Linux job installs required system dependencies
- Release job waits for all builds and creates GitHub Release
- SHA256SUMS.txt generated for all artifacts
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Workflow and Document Secrets</name>
  <files>.github/workflows/release.yml</files>
  <action>
Perform final verification and add documentation comments:

1. Add header comment to release.yml explaining required secrets:
   ```yaml
   # Release Workflow for PhoneSync
   #
   # Triggers on: git tag push matching v*.*.*
   # Example: git tag v1.0.0 && git push origin v1.0.0
   #
   # Required GitHub Secrets:
   #   KEYSTORE_BASE64 - Base64-encoded .jks keystore (base64 -i upload-keystore.jks)
   #   KEYSTORE_PASSWORD - Keystore password
   #   KEY_PASSWORD - Key password (often same as keystore password)
   #   KEY_ALIAS - Key alias (e.g., "upload")
   #
   # Outputs:
   #   - android_provider-{version}.apk (signed)
   #   - desktop_client-macos-{version}.zip
   #   - desktop_client-windows-{version}.zip
   #   - desktop_client-linux-{version}.tar.gz
   #   - SHA256SUMS.txt
   ```

2. Verify working directories match monorepo structure:
   - Android app: apps/android_provider
   - Desktop app: apps/desktop_client

3. Verify artifact paths match Flutter build outputs:
   - Android: build/app/outputs/flutter-apk/app-release.apk
   - macOS: build/macos/Build/Products/Release/desktop_client.app
   - Windows: build/windows/x64/runner/Release/
   - Linux: build/linux/x64/release/bundle/
  </action>
  <verify>
1. release.yml has documentation header with secrets list
2. All working-directory paths are correct for monorepo
3. YAML syntax is valid
4. Run `git diff .github/workflows/release.yml` to see final file
  </verify>
  <done>
- Workflow file has clear documentation header
- Required secrets are documented
- All paths verified for monorepo structure
- Workflow ready for use
  </done>
</task>

</tasks>

<verification>
1. Workflow file exists at `.github/workflows/release.yml`

2. Workflow triggers correctly:
   - `on: push: tags: - 'v*.*.*'`

3. All 4 platform jobs defined:
   - build-android (ubuntu-latest)
   - build-macos (macos-14)
   - build-windows (windows-latest)
   - build-linux (ubuntu-latest)

4. Android signing configured:
   - Decodes KEYSTORE_BASE64
   - Creates key.properties from secrets

5. Linux dependencies installed:
   - clang, cmake, ninja-build, pkg-config, libgtk-3-dev, libstdc++-12-dev

6. Release job dependencies:
   - `needs: [build-android, build-macos, build-windows, build-linux]`

7. Artifacts uploaded with SHA256 checksums

8. Release body includes download table
</verification>

<success_criteria>
- Pushing v*.*.* tag will trigger workflow
- All 4 platforms build in parallel
- Android APK signed with release keystore
- Linux builds with required dependencies
- GitHub Release created with all artifacts
- SHA256SUMS.txt included for verification
- Workflow completes within 30 minutes (parallel builds)
</success_criteria>

<output>
After completion, create `.planning/phases/04-release-pipeline/04-02-SUMMARY.md`
</output>
