---
phase: 04-release-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/android_provider/android/app/build.gradle.kts
  - apps/android_provider/android/.gitignore
  - apps/desktop_client/linux/CMakeLists.txt
  - apps/desktop_client/linux/flutter/CMakeLists.txt
  - apps/desktop_client/linux/runner/main.cc
  - apps/desktop_client/linux/runner/my_application.cc
  - apps/desktop_client/linux/runner/my_application.h
autonomous: true
user_setup:
  - service: github-secrets
    why: "Android APK signing requires keystore secrets"
    env_vars:
      - name: KEYSTORE_BASE64
        source: "Generate keystore with keytool, then base64 -i upload-keystore.jks"
      - name: KEYSTORE_PASSWORD
        source: "Password set during keytool -genkey"
      - name: KEY_PASSWORD
        source: "Key password set during keytool -genkey"
      - name: KEY_ALIAS
        source: "Alias set during keytool -genkey (e.g., 'upload')"
    dashboard_config:
      - task: "Add secrets to repository"
        location: "GitHub repo -> Settings -> Secrets and variables -> Actions -> New repository secret"

must_haves:
  truths:
    - "Android APK can be signed with release keystore when key.properties exists"
    - "Build falls back to debug signing when key.properties absent"
    - "Linux platform is enabled for desktop_client app"
    - "flutter build linux command succeeds locally"
  artifacts:
    - path: "apps/android_provider/android/app/build.gradle.kts"
      provides: "Release signing configuration"
      contains: "signingConfigs"
    - path: "apps/android_provider/android/.gitignore"
      provides: "Excludes key.properties and keystore"
      contains: "key.properties"
    - path: "apps/desktop_client/linux/CMakeLists.txt"
      provides: "Linux build configuration"
      contains: "cmake_minimum_required"
  key_links:
    - from: "apps/android_provider/android/app/build.gradle.kts"
      to: "key.properties"
      via: "Properties file loading"
      pattern: "keystoreProperties.*load"
---

<objective>
Configure Android release signing and enable Linux platform support

Purpose: Prepare both apps for multi-platform CI/CD builds. Android needs release keystore support; desktop needs Linux target enabled.
Output: build.gradle.kts with signing config, Linux platform files for desktop_client
</objective>

<execution_context>
@/Users/jay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-release-pipeline/04-RESEARCH.md
@apps/android_provider/android/app/build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Android Release Signing</name>
  <files>
    apps/android_provider/android/app/build.gradle.kts
    apps/android_provider/android/.gitignore
  </files>
  <action>
Update build.gradle.kts to support release signing with key.properties:

1. Add imports at top of file:
   ```kotlin
   import java.util.Properties
   import java.io.FileInputStream
   ```

2. After plugins block, add keystore properties loading:
   ```kotlin
   val keystoreProperties = Properties()
   val keystorePropertiesFile = rootProject.file("key.properties")
   if (keystorePropertiesFile.exists()) {
       keystoreProperties.load(FileInputStream(keystorePropertiesFile))
   }
   ```

3. Inside android block, add signingConfigs before buildTypes:
   ```kotlin
   signingConfigs {
       create("release") {
           keyAlias = keystoreProperties["keyAlias"] as String?
           keyPassword = keystoreProperties["keyPassword"] as String?
           storeFile = keystoreProperties["storeFile"]?.let { file(it) }
           storePassword = keystoreProperties["storePassword"] as String?
       }
   }
   ```

4. Update buildTypes.release block:
   ```kotlin
   buildTypes {
       release {
           signingConfig = if (keystorePropertiesFile.exists()) {
               signingConfigs.getByName("release")
           } else {
               signingConfigs.getByName("debug")
           }
       }
   }
   ```

5. Update .gitignore to exclude secrets:
   - Add `key.properties`
   - Add `*.jks` (keystore files)
   - Add `*.keystore`
  </action>
  <verify>
Run from apps/android_provider directory:
- `cd apps/android_provider && flutter build apk --release` should succeed (falls back to debug signing)
- Verify build.gradle.kts has signingConfigs block
- Verify .gitignore contains key.properties
  </verify>
  <done>
- build.gradle.kts loads key.properties if present
- build.gradle.kts has release signingConfig
- Fallback to debug signing works when key.properties absent
- .gitignore excludes key.properties and *.jks files
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable Linux Platform for Desktop Client</name>
  <files>
    apps/desktop_client/linux/CMakeLists.txt
    apps/desktop_client/linux/flutter/CMakeLists.txt
    apps/desktop_client/linux/runner/main.cc
    apps/desktop_client/linux/runner/my_application.cc
    apps/desktop_client/linux/runner/my_application.h
  </files>
  <action>
Enable Linux platform and create required files:

1. From apps/desktop_client directory, run:
   ```bash
   flutter create --platforms=linux .
   ```
   This generates the linux/ directory with all required build files.

2. Verify the generated files exist:
   - linux/CMakeLists.txt (top-level Linux build config)
   - linux/flutter/CMakeLists.txt (Flutter integration)
   - linux/runner/main.cc (entry point)
   - linux/runner/my_application.cc (GTK application wrapper)
   - linux/runner/my_application.h (header)

3. Update linux/CMakeLists.txt if needed to set app name:
   - Look for `set(BINARY_NAME` and ensure it's "desktop_client" or appropriate name

Note: The flutter create command is idempotent - it adds Linux support without affecting existing Windows/macOS config.
  </action>
  <verify>
Run from apps/desktop_client directory:
- `ls -la linux/` shows CMakeLists.txt and runner/ directory
- `flutter config --list` shows linux-desktop enabled
- On Linux system: `flutter build linux --release` would succeed (skip on macOS/Windows)
  </verify>
  <done>
- linux/ directory exists with CMakeLists.txt
- linux/runner/ contains main.cc, my_application.cc, my_application.h
- Flutter recognizes desktop_client as supporting Linux platform
  </done>
</task>

</tasks>

<verification>
1. Android build.gradle.kts contains:
   - `import java.util.Properties`
   - `keystoreProperties = Properties()`
   - `signingConfigs { create("release") { ... } }`
   - Conditional signingConfig in buildTypes.release

2. Android .gitignore contains:
   - `key.properties`
   - `*.jks`

3. Desktop client Linux files exist:
   - `apps/desktop_client/linux/CMakeLists.txt`
   - `apps/desktop_client/linux/runner/main.cc`

4. Flutter build commands succeed:
   - `cd apps/android_provider && flutter build apk --release` (debug signing fallback)
</verification>

<success_criteria>
- Android app can be built with release signing when key.properties exists
- Android app falls back to debug signing without key.properties (CI flexibility)
- Keystore secrets are gitignored
- Linux platform is enabled for desktop_client
- All platform build configurations ready for CI/CD workflow
</success_criteria>

<output>
After completion, create `.planning/phases/04-release-pipeline/04-01-SUMMARY.md`
</output>
