---
phase: 01-android-data-provider
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - melos.yaml
  - pubspec.yaml
  - apps/android_provider/pubspec.yaml
  - apps/android_provider/android/app/src/main/AndroidManifest.xml
  - apps/android_provider/lib/main.dart
  - apps/android_provider/lib/app.dart
  - packages/core/pubspec.yaml
  - packages/core/lib/core.dart
autonomous: true

must_haves:
  truths:
    - "Flutter monorepo structure exists with Melos"
    - "android_provider app runs on Android emulator/device"
    - "Android manifest declares contacts, SMS, and call log permissions"
  artifacts:
    - path: "melos.yaml"
      provides: "Monorepo workspace configuration"
      contains: "packages:"
    - path: "apps/android_provider/pubspec.yaml"
      provides: "App dependencies"
      contains: "flutter_riverpod"
    - path: "apps/android_provider/android/app/src/main/AndroidManifest.xml"
      provides: "Android permissions declaration"
      contains: "READ_CONTACTS"
  key_links:
    - from: "melos.yaml"
      to: "apps/android_provider"
      via: "workspace packages glob"
      pattern: "apps/\\*\\*"
    - from: "apps/android_provider/pubspec.yaml"
      to: "packages/core"
      via: "path dependency"
      pattern: "path:.*packages/core"
---

<objective>
Set up Flutter monorepo with Melos workspace, create Android provider app skeleton, and configure Android permissions for contacts, SMS, and call log access.

Purpose: Establish the foundation for the Android data extraction app with proper project structure and platform configuration.
Output: Running Flutter app with correct Android permissions declared, ready for feature implementation.
</objective>

<execution_context>
@/Users/jay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-android-data-provider/01-CONTEXT.md
@.planning/phases/01-android-data-provider/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Flutter monorepo with Melos</name>
  <files>
    melos.yaml
    pubspec.yaml
    apps/android_provider/pubspec.yaml
    apps/android_provider/lib/main.dart
    apps/android_provider/lib/app.dart
    packages/core/pubspec.yaml
    packages/core/lib/core.dart
  </files>
  <action>
1. Initialize root pubspec.yaml with workspace name "jljm_phonesync" and Melos dev dependency

2. Create melos.yaml with:
   - name: jljm_phonesync
   - packages: ["apps/*", "packages/*"]
   - sdkPath: .fvm/flutter_sdk (for FVM compatibility, optional)
   - scripts for bootstrap, clean, analyze

3. Create apps/android_provider using `flutter create`:
   ```bash
   flutter create --org com.jljm --project-name android_provider apps/android_provider
   ```

4. Update apps/android_provider/pubspec.yaml with dependencies from research:
   ```yaml
   dependencies:
     flutter:
       sdk: flutter
     flutter_contacts: ^1.1.9+2
     call_log: ^6.0.1
     another_telephony: ^0.4.1
     permission_handler: ^12.0.1
     shared_preferences: ^2.3.0
     flutter_riverpod: ^3.2.0
     core:
       path: ../../packages/core

   dev_dependencies:
     flutter_test:
       sdk: flutter
     flutter_lints: ^5.0.0
     riverpod_generator: ^2.6.5
     build_runner: ^2.4.15
   ```

5. Create packages/core as shared types package:
   - pubspec.yaml with basic Flutter dependencies
   - lib/core.dart with barrel export
   - lib/src/models/ directory for shared models (placeholder)

6. Replace apps/android_provider/lib/main.dart with Riverpod setup:
   ```dart
   import 'package:flutter/material.dart';
   import 'package:flutter_riverpod/flutter_riverpod.dart';
   import 'app.dart';

   void main() {
     runApp(const ProviderScope(child: PhoneSyncApp()));
   }
   ```

7. Create apps/android_provider/lib/app.dart with MaterialApp placeholder:
   ```dart
   import 'package:flutter/material.dart';

   class PhoneSyncApp extends StatelessWidget {
     const PhoneSyncApp({super.key});

     @override
     Widget build(BuildContext context) {
       return MaterialApp(
         title: 'PhoneSync',
         theme: ThemeData(
           colorScheme: ColorScheme.fromSeed(seedColor: Colors.blue),
           useMaterial3: true,
         ),
         home: const Scaffold(
           body: Center(child: Text('PhoneSync - Setup Complete')),
         ),
       );
     }
   }
   ```

8. Run `melos bootstrap` to link packages
  </action>
  <verify>
    - `melos bootstrap` completes without errors
    - `flutter pub get` works in apps/android_provider
    - `flutter analyze apps/android_provider` shows no errors
  </verify>
  <done>
    - Monorepo structure exists with melos.yaml
    - android_provider app has all dependencies from research
    - core package exists and is linked
    - App compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Android permissions and manifest</name>
  <files>
    apps/android_provider/android/app/src/main/AndroidManifest.xml
    apps/android_provider/android/app/build.gradle.kts
  </files>
  <action>
1. Update apps/android_provider/android/app/src/main/AndroidManifest.xml to add required permissions BEFORE the application tag:
   ```xml
   <manifest xmlns:android="http://schemas.android.com/apk/res/android">
       <!-- Contacts permission -->
       <uses-permission android:name="android.permission.READ_CONTACTS"/>

       <!-- SMS permissions -->
       <uses-permission android:name="android.permission.READ_SMS"/>

       <!-- Call log permissions (requires READ_PHONE_STATE on Android 9+) -->
       <uses-permission android:name="android.permission.READ_CALL_LOG"/>
       <uses-permission android:name="android.permission.READ_PHONE_STATE"/>

       <application
           android:label="PhoneSync"
           android:name="${applicationName}"
           android:icon="@mipmap/ic_launcher">
           <!-- existing activity config -->
       </application>
   </manifest>
   ```

2. Ensure apps/android_provider/android/app/build.gradle.kts has correct SDK versions:
   - minSdk = 21 (minimum for all packages)
   - targetSdk = 34 (Android 14)
   - compileSdk = 34

3. Verify the applicationId is "com.jljm.android_provider" (or adjust to preference)

Note: Do NOT add queries for telephony - not needed for reading SMS via content provider.
  </action>
  <verify>
    - `flutter build apk --debug` completes without permission-related errors
    - AndroidManifest.xml contains READ_CONTACTS, READ_SMS, READ_CALL_LOG, READ_PHONE_STATE
    - build.gradle.kts shows minSdk >= 21, targetSdk = 34
  </verify>
  <done>
    - All 4 Android permissions declared in manifest
    - App builds for Android without errors
    - SDK versions configured correctly
  </done>
</task>

</tasks>

<verification>
Run these commands to verify plan completion:

```bash
# Structure verification
ls melos.yaml apps/android_provider/pubspec.yaml packages/core/pubspec.yaml

# Dependencies linked
melos bootstrap

# Android build
cd apps/android_provider && flutter build apk --debug

# Manifest check
grep -E "READ_CONTACTS|READ_SMS|READ_CALL_LOG" apps/android_provider/android/app/src/main/AndroidManifest.xml
```
</verification>

<success_criteria>
1. `melos bootstrap` succeeds
2. `flutter build apk --debug` in apps/android_provider succeeds
3. AndroidManifest.xml contains all 4 required permissions
4. App launches on Android emulator showing "PhoneSync - Setup Complete"
</success_criteria>

<output>
After completion, create `.planning/phases/01-android-data-provider/01-01-SUMMARY.md`
</output>
